name: Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    # Use Ubuntu for x64 builds
    runs-on: ubuntu-latest

    # Optional: Set a timeout for the job
    timeout-minutes: 15

    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v4
      # Important: Fetch all history for proper versioning
      with:
        fetch-depth: 0

    - name: âš™ï¸ Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        # Use the latest stable Flutter version (3.35.7 as of the current date)
        flutter-version: '3.35.7'
        # The default channel is 'stable', but specifying it is good practice
        channel: 'stable'
        # Set architecture to x64 for the ubuntu-latest runner
        architecture: x64
        # Enable caching for pub packages
        cache: true

    - name: ğŸ” licenses
      run: yes | flutter doctor --android-licenses

    - name: ğŸ” deps
      run: |
        sudo apt update
        sudo apt install libgtk-3-dev -y
        sudo apt install mesa-utils -y

    - name: ğŸ” upgrade
      run: flutter upgrade

    - name: ğŸ” Check version
      run: flutter --version

    - name: ğŸ—ï¸ Create builds
      run: flutter create . --platforms android,ios,web

    - name: ğŸ“¦ Install dependencies
      run: flutter pub get

    - name: ğŸ“¦ upgrade dependencies
      run: flutter pub upgrade --major-versions

    - name: Outdated dependencies
      run: flutter pub outdated

    - name: ğŸ’ Install CocoaPods
      run: |
        sudo gem install cocoapods

    - name: ğŸ” doctor
      run: flutter doctor

    - name: ğŸ” print formatting
      run: dart format --output=show .

    - name: ğŸ” Check formatting
      run: dart format --set-exit-if-changed .

    - name: ğŸ” doctor
      run: flutter doctor

    - name: ğŸ“ Run static analysis
      run: flutter analyze

    - name: ğŸ§ª Run tests
      # Run tests with code coverage
      run: flutter test --coverage

    - name: ğŸ—ï¸ Build Web Release
      run: flutter build web --release

    - name: ğŸš€ Upload Web Artifact
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: build/web

    - name: ğŸ—ï¸ Build Android App Bundle (.apk)
      # The signing is handled automatically by Gradle using the files set up above
      run: flutter build apk --release

    - name: ğŸ“¤ Upload Android Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-aab
        path: build/app/outputs/bundle/release/app-release.aab



    # - name: ğŸ—ï¸ Build iOS Archive
    #   # Creates the .xcarchive file
    #   run: flutter build ios --no-codesign

    # - name: ğŸ“¦ Create Unsigned IPA
    #   # Uses xcodebuild to convert the archive to an IPA without distribution signing
    #   run: |
    #     # The ExportOptions.plist must be present in your repository
    #     ARCHIVE_PATH=$(find build/ios/archive/ -type d -name "*.xcarchive" -print -quit)
        
    #     mkdir -p build/ios/ipa
    #     xcodebuild -exportArchive \
    #         -archivePath "$ARCHIVE_PATH" \
    #         -exportPath build/ios/ipa \
    #         -exportOptionsPlist ios/ExportOptions.plist

    # - name: ğŸ“¤ Upload iOS Artifact
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: unsigned-ipa
    #     path: build/ios/ipa/*.ipa

    # - name: ğŸ’» Build Linux Release
    #   # Enable a Linux desktop target (requires dependencies)
    #   run: |
    #     sudo apt-get update -y
    #     sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev
    #     flutter config --enable-linux-desktop
    #     flutter build linux --release

    # - name: â¬†ï¸ Upload Linux Artifact
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: linux-build
    #     path: build/linux/x64/release/bundle


  tag_version:
    ## New Job: Calculates the next version and creates the tag on 'main'
    name: Create Semantic Version Tag
    runs-on: ubuntu-latest
    needs: build
    # Only run this step if the previous job was successful and it's a push to main
    if: success() && github.ref == 'refs/heads/main'
    
    permissions:
      contents: write # Required to create a tag/release

    # ğŸŸ¢ ADDED: Expose the output from the 'semver' step to the job level
    outputs:
      new_tag: ${{ steps.semver.outputs.tag }}
    
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for git tag detection

      - name: ğŸ·ï¸ Get next SemVer and Create Tag
        id: semver
        uses: 'actions/github-script@v7'
        with:
          script: |
            const getNextVersion = (tags) => {
              // Find the latest version tag (e.g., v1.2.3)
              const latestTag = tags
                .map(tag => tag.name)
                .filter(name => name.startsWith('v') && /v\d+\.\d+\.\d+$/.test(name))
                .sort()
                .pop()
              
              if (!latestTag) {
                return 'v1.0.0'; // Default to v1.0.0 if no tags exist
              }
              
              // Increment the patch version (e.g., v1.2.3 -> v1.2.4)
              const parts = latestTag.substring(1).split('.').map(Number);
              parts[2] += 1; // Increment patch
              return `v${parts.join('.')}`;
            }

            // 1. Get all tags
            const { data: tags } = await github.rest.repos.listTags({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            // 2. Calculate the next version
            const nextTag = getNextVersion(tags);
            console.log(`Next release tag will be: ${nextTag}`);

            // 3. Create the new tag
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${nextTag}`,
              sha: context.sha
            });

            // 4. Set the tag as an output for the job
            core.setOutput('tag', nextTag);
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    needs: [build, tag_version] # Depend on the new tagging job
    
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # Step 1: Download the artifact from the 'build' job
      - name: ğŸ“¥ Download Android Artifact
        uses: actions/download-artifact@v4
        with:
          name: release-aab
          path: build/app/outputs/bundle/release/

      - name: Locate and Rename Android AAB
        id: locate_file # Add an ID to reference outputs
        run: |
          # ğŸŸ¢ MODIFIED: Correctly access the job output 'new_tag'
          TAG=${{ needs.tag_version.outputs.new_tag }} 

          # Example path to your built AAB file 
          AAB_PATH=build/app/outputs/bundle/release/app-release.aab

          # Define the final asset name for the release
          ASSET_NAME="qr-ipfs-${TAG}.aab"

          # Move/rename the file to the root of the workspace for easy upload
          mv $AAB_PATH $ASSET_NAME
          
          # Output the asset name for the release step to use
          echo "ASSET_NAME=$ASSET_NAME" >> $GITHUB_OUTPUT 
        
      # Step 3: Create the Draft Release and Upload the Asset
      - name: ğŸ“ Create Draft GitHub Release and Upload AAB
        uses: softprops/action-gh-release@v1
        with:
          # ğŸŸ¢ MODIFIED: Correctly use the job output 'new_tag'
          tag_name: ${{ needs.tag_version.outputs.new_tag }}
          
          # Use the filename created in the previous step's output
          files: ${{ steps.locate_file.outputs.ASSET_NAME }} 
          
          # Add 'draft: true' to create a draft release
          draft: true
          
          # ğŸŸ¢ MODIFIED: Correctly use the job output 'new_tag'
          name: Draft Release ${{ needs.tag_version.outputs.new_tag }}
